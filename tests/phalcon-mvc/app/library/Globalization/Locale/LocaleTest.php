<?php

namespace OpenExam\Library\Globalization\Locale;

use OpenExam\Tests\Phalcon\TestCase;

/**
 * @author Anders Lövgren (Computing Department at BMC, Uppsala University)
 */
class LocaleTester extends Locale
{

        public function __construct($locale = null)
        {
                parent::__construct($locale);
                $this->sapi = __CLASS__;
        }

        public function setSapi($sapi)
        {
                $this->sapi = $sapi;
        }

}

/**
 * Generated by PHPUnit_SkeletonGenerator 1.2.1 on 2014-09-23 at 15:49:14.
 * @author Anders Lövgren (Computing Department at BMC, Uppsala University)
 */
class LocaleTest extends TestCase
{

        /**
         * @var Locale
         */
        protected $object;
        protected static $locales = array(
                'sv_SE.UTF-8' => 'Swedish',
                'en_US'       => 'English (US)'
        );

        /**
         * Sets up the fixture, for example, opens a network connection.
         * This method is called before a test is executed.
         * @covers OpenExam\Library\Globalization\Locale\Locale::__construct
         */
        protected function setUp()
        {
                $this->object = new LocaleTester();
        }

        /**
         * Tears down the fixture, for example, closes a network connection.
         * This method is called after a test is executed.
         */
        protected function tearDown()
        {
                
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::setLocales
         * @group globalization
         */
        public function testSetLocales()
        {
                self::assertTrue(count($this->object->getLocales()) == 0);
                $this->object->setLocales(self::$locales);
                self::assertTrue(count($this->object->getLocales()) != 0);
                self::assertTrue(count($this->object->getLocales()) == count(self::$locales));
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::getLocales
         * @group globalization
         */
        public function testGetLocales()
        {
                self::assertTrue(count($this->object->getLocales()) == 0);
                self::assertTrue(is_array($this->object->getLocales()));
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::addLocale
         * @group globalization
         */
        public function testAddLocale()
        {
                self::assertTrue(count($this->object->getLocales()) == 0);
                $this->object->addLocale('fr_FR.UTF-8', 'French');
                self::assertTrue(count($this->object->getLocales()) == 1);
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::setLocale
         * @group globalization
         */
        public function testSetLocale()
        {
                $locale = setlocale(LC_ALL, "0");
                $expect = "fr_FR";
                $this->object->setLocale($expect);
                $actual = setlocale(LC_ALL, "0");
                self::assertEquals($actual, $expect);
                setlocale(LC_ALL, $locale);     // restore
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::getLocale
         * @group globalization
         */
        public function testGetLocale()
        {
                self::assertNotNull($this->object->getLocale());
                $expect = "fr_FR";
                $this->object->setLocale($expect);
                $actual = $this->object->getLocale();
                self::assertNotNull($this->object->getLocale());
                self::assertEquals($actual, $expect);
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::hasLocale
         * @group globalization
         */
        public function testHasLocale()
        {
                self::assertFalse($this->object->hasLocale(key(self::$locales)));
                $this->object->setLocales(null);
                self::assertFalse($this->object->hasLocale(key(self::$locales)));
                $this->object->setLocales(self::$locales);
                self::assertTrue($this->object->hasLocale(key(self::$locales)));
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::getDisplayLanguage
         * @group globalization
         */
        public function testGetDisplayLanguage()
        {
                if (!extension_loaded('intl')) {
                        self::markTestIncomplete("Extension intl is not loaded");
                } else {
                        $expect = "Swedish";
                        $actual = $this->object->getDisplayLanguage('sv_SE');
                        self::assertEquals($actual, $expect);
                }
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::detect
         * @group globalization
         */
        public function testDetect()
        {
                $name = 'lang';

                // 
                // Make sure request honours "live" mode:
                // 
                $expect = 'sv';
                $_REQUEST[$name] = $expect;
                $actual = $this->request->get($name);
                self::assertNotNull($actual);
                self::assertEquals($actual, $expect);

                $this->object->setLocales(self::$locales);
                $default = 'C';

                // 
                // Test web:
                // 
                $this->object->setSapi('web');
                foreach (array(
                    'sv_SE.UTF-8' => 'sv_SE.UTF-8', // locale
                    'sv'          => 'sv_SE.UTF-8', // lang
                    'se'          => 'sv_SE.UTF-8', // variant
                    'en'          => 'en_US',
                    'fr'          => $default) as $lang => $expect) {
                        // 
                        // Match request param:
                        // 
                        $_REQUEST[$name] = $lang;
                        $actual = $this->object->detect($name, $default);
                        printf("%s(%s): lang=%s, expect=%s, actual=%s\n", __METHOD__, "request", $lang, $expect, $actual);
                        self::assertNotNull($actual);
                        self::assertEquals($expect, $actual);
                        unset($_REQUEST[$name]);

                        // 
                        // Match session:
                        // 
                        $this->session->start();
                        if ($this->session->isStarted()) {
                                $this->session->set($name, $lang);
                                $actual = $this->object->detect($name, $default);
                                printf("%s(%s): lang=%s, expect=%s, actual=%s\n", __METHOD__, "session", $lang, $expect, $actual);
                                self::assertNotNull($actual);
                                self::assertEquals($expect, $actual);
                                $this->session->destroy();
                        }

                        // 
                        // Match persistent storage:
                        // 
                        if (isset($this->persistent)) {
                                $this->persistent->set($name, $lang);
                                $actual = $this->object->detect($name, $default);
                                printf("%s(%s): lang=%s, expect=%s, actual=%s\n", __METHOD__, "persistent", $lang, $expect, $actual);
                                self::assertNotNull($actual);
                                self::assertEquals($expect, $actual);
                                $this->persistent->remove($name);
                        }

                        // 
                        // Match HTTP accept language:
                        // 
                        $_SERVER['HTTP_ACCEPT_LANGUAGE'] = $lang;
                        $actual = $this->object->detect($name, $default);
                        printf("%s(%s): lang=%s, expect=%s, actual=%s\n", __METHOD__, "accept", $lang, $expect, $actual);
                        self::assertNotNull($actual);
                        self::assertEquals($expect, $actual);
                }

                // 
                // Test CLI:
                // 
                $this->object->setSapi('cli');
                foreach (array(
                    'sv_SE.UTF-8' => 'sv_SE.UTF-8', // locale
                    'sv'          => 'sv_SE.UTF-8', // lang
                    'se'          => 'sv_SE.UTF-8', // variant
                    'en'          => 'en_US',
                    'fr'          => $default) as $lang => $expect) {
                        foreach (array('LANG', 'LC_CTYPE') as $name) {
                                putenv("$name=$lang");
                                self::assertEquals($lang, getenv($name));
                                $actual = $this->object->detect($name, $default);
                                printf("%s(%s): lang=%s, expect=%s, actual=%s\n", __METHOD__, "cli[$name]", $lang, $expect, $actual);
                                self::assertNotNull($actual);
                                self::assertEquals($expect, $actual);
                        }
                }
        }

        /**
         * @covers OpenExam\Library\Globalization\Locale\Locale::findLocales
         * @group globalization
         */
        public function testFindLocales()
        {
                $locales = $this->object->findLocales($this->config->application->localeDir);
                self::assertNotNull($locales);
                self::assertTrue(count($locales) > 0);
        }

}
