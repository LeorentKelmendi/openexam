<?php

namespace OpenExam\Library\Security;

use OpenExam\Tests\Phalcon\TestCase;

/**
 * Generated by PHPUnit_SkeletonGenerator 1.2.1 on 2014-09-02 at 11:26:01.
 * 
 * @author Anders LÃ¶vgren (Computing Department at BMC, Uppsala University)
 */
class UserTest extends TestCase
{

        /**
         * @var User
         */
        protected $object;
        private static $user = 'user1';
        private static $domain = 'domain1';
        private static $role = 'role1';

        /**
         * Sets up the fixture, for example, opens a network connection.
         * This method is called before a test is executed.
         */
        protected function setUp()
        {
                $this->object = new User(self::$user, self::$domain, self::$role);
        }

        /**
         * Tears down the fixture, for example, closes a network connection.
         * This method is called after a test is executed.
         */
        protected function tearDown()
        {
                
        }

        /**
         * @covers OpenExam\Library\Security\User::__construct
         * @group security
         */
        public function testConstructor()
        {
                // 
                // test User(user, domain):
                // 
                $user = self::$user;
                $domain = self::$domain;
                $this->object = new User($user, $domain);
                $expect = sprintf("%s@%s", $user, $domain);
                $actual = $this->object->getPrincipalName();
                self::assertEquals($expect, $actual);

                // 
                // test User(principal):
                // 
                $user = sprintf("%s@%s", self::$user, self::$domain);
                $this->object = new User($user);
                $expect = $user;
                $actual = $this->object->getPrincipalName();
                self::assertEquals($expect, $actual);

                // 
                // test User(user): -> using default domain
                // 
                $user = self::$user;
                $domain = $this->config->user->domain;
                $this->object = new User($user);
                $expect = sprintf("%s@%s", self::$user, $domain);
                $actual = $this->object->getPrincipalName();
                self::assertEquals($expect, $actual);

                // 
                // test User(user): -> without default domain (throws)
                // 
                $user = self::$user;
                try {
                        $this->object = new User($user);
                        self::error();
                } catch (\Exception $exception) {
                        
                }

                // 
                // test User(null): -> empty user
                // 
                $user = self::$user;
                try {
                        $this->object = new User();
                } catch (\Exception $exception) {
                        self::error();
                }

                // 
                // Test default domain unset in config:
                // 
                $domain = $this->config->user->domain;
                $this->config->user->domain = null;
                $user = sprintf("%s@%s", self::$user, self::$domain);
                try {
                        $this->object = new User($user);
                } catch (\Exception $exception) {
                        self::error($exception);
                }
                $user = self::$user;
                try {
                        $this->object = new User($user);
                        self::error();
                } catch (\Exception $exception) {
                        // OK, should throw
                }
                $this->config->user->domain = $domain;

                // 
                // test User(user, null, roles): -> "act-as" (impersonation).
                // 
                $roles = array(
                        0 => array(Roles::ADMIN, Roles::TEACHER),
                        1 => array(Roles::CONTRIBUTOR),
                        2 => array(Roles::DECODER, Roles::INVIGILATOR),
                        3 => array(Roles::INVIGILATOR)
                );
                $this->object = new User($user, null, null, $roles);
                self::assertTrue(count($this->object->roles->getRoles(0)) == 5);
                self::assertTrue(count($this->object->roles->getRoles(1)) == 1);
                self::assertTrue(count($this->object->roles->getRoles(2)) == 2);
                self::assertTrue(count($this->object->roles->getRoles(3)) == 1);
                self::assertTrue(count($this->object->roles->getRoles(4)) == 0);
                self::assertTrue(count($this->object->roles->getAllRoles()) == 4);
                self::assertTrue(count($this->object->roles->getAllRoles()[1]) == 1);

                self::assertTrue($this->object->roles->hasRole(Roles::ADMIN));
                self::assertTrue($this->object->roles->hasRole(Roles::TEACHER));
                self::assertTrue($this->object->roles->hasRole(Roles::CONTRIBUTOR));
                self::assertTrue($this->object->roles->hasRole(Roles::DECODER));
                self::assertTrue($this->object->roles->hasRole(Roles::INVIGILATOR));

                self::assertTrue($this->object->roles->hasRole(Roles::DECODER, 2));
                self::assertTrue($this->object->roles->hasRole(Roles::INVIGILATOR, 2));
                self::assertFalse($this->object->roles->hasRole(Roles::DECODER, 3));
        }

        /**
         * Test the roles property.
         * @coversNothing
         * @group security
         */
        public function testRolesProperty()
        {
                $roles = $this->object->roles;
                self::assertNotNull($roles);
                self::assertInstanceOf('\OpenExam\Library\Security\Roles', $roles);
        }

        /**
         * @covers OpenExam\Library\Security\User::getPrincipalName
         * @group security
         */
        public function testGetPrincipalName()
        {
                $principal = sprintf("%s@%s", self::$user, self::$domain);
                self::assertNotNull($this->object->getPrincipalName());
                self::assertNotEmpty($this->object->getPrincipalName());
                self::assertTrue($this->object->getPrincipalName() == $principal);

                $this->object = new User();
                self::assertNull($this->object->getPrincipalName());
        }

        /**
         * @covers OpenExam\Library\Security\User::getDomain
         * @group security
         */
        public function testGetDomain()
        {
                self::assertNotNull($this->object->getDomain());
                self::assertNotEmpty($this->object->getDomain());
                self::assertTrue($this->object->getDomain() == self::$domain);

                $this->object = new User();
                self::assertNull($this->object->getDomain());
        }

        /**
         * @covers OpenExam\Library\Security\User::getUser
         * @group security
         */
        public function testGetUser()
        {
                self::assertNotNull($this->object->getUser());
                self::assertNotEmpty($this->object->getUser());
                self::assertTrue($this->object->getUser() == self::$user);

                $this->object = new User();
                self::assertNull($this->object->getUser());
        }

        /**
         * @covers OpenExam\Library\Security\User::getPrimaryRole
         * @group security
         */
        public function testGetPrimaryRole()
        {
                self::assertNotNull($this->object->getPrimaryRole());
                self::assertNotEmpty($this->object->getPrimaryRole());
                self::assertTrue($this->object->getPrimaryRole() == self::$role);

                $this->object = new User();
                self::assertNull($this->object->getPrimaryRole());
        }

        /**
         * @covers OpenExam\Library\Security\User::setPrimaryRole
         * @group security
         */
        public function testSetPrimaryRole()
        {
                self::assertNotNull($this->object->getPrimaryRole());

                $this->object->setPrimaryRole(null);
                self::assertNull($this->object->getPrimaryRole());

                $expect = 'somerole';
                $this->object->setPrimaryRole($expect);
                $actual = $this->object->getPrimaryRole();
                self::assertEquals($expect, $actual);
        }

        /**
         * @covers OpenExam\Library\Security\User::hasPrimaryRole
         * @group security
         */
        public function testHasPrimaryRole()
        {
                self::assertTrue($this->object->hasPrimaryRole());
                $this->object->setPrimaryRole(null);
                self::assertFalse($this->object->hasPrimaryRole());
        }

        /**
         * @covers OpenExam\Library\Security\User::__toString
         * @group security
         */
        public function testToString()
        {
                $expect = sprintf("%s@%s", self::$user, self::$domain);
                $actual = (string) $this->object;
                self::assertNotNull($actual);
                self::assertEquals($expect, $actual);
        }

}
