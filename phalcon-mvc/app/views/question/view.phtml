<!-- TODO: load only if a question type is canvas -->
<?= Phalcon\Tag::stylesheetLink("plugins/canvas/css/literallycanvas.css"); ?>
<?= Phalcon\Tag::stylesheetLink("plugins/ckeditor/skins/notification.css"); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/canvas/js/react-with-addons.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/canvas/js/ie_customevent.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/canvas/js/literallycanvas.min.js'); ?>

<!-- view.phtml specific js -->
<?= Phalcon\Tag::javascriptInclude('js/views/question/view.js'); ?>

<?php if ($viewMode == 'all'): ?>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
            extensions: ["tex2jax.js"],
            jax: ["input/TeX","output/HTML-CSS"],
            tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
            });
        </script>
        <?= Phalcon\Tag::javascriptInclude('js/mathjax/MathJax.js'); ?>
<?php endif; ?>

<!-- question content row ends --> 
<div class='col-xs-12'>

    <!-- question title row -->
    <?php if ($testMode): ?>
            <div class="alert alert-info alert-dismissable" style="margin:15px 0px;">  
                <strong>Test mode activated.</strong> <br />
                You are currently previewing these questions in test mode. Please note that your Answers will <strong>not</strong> be saved.<br />
                If you see any issues, please feel free to <a href="#">contact us</a>.
                Click <a href="<?= $this->url->get('exam/index') ?>">here</a> to return back on exam management page.
            </div>
    <?php endif; ?>

    <?php if (!$testMode && $viewMode == 'all'): ?>
            <div class="alert alert-info alert-dismissable" style="margin:15px 0px;">  
                <a href="#" data-dismiss="alert" class="close">Ã—</a>
                <p>Careful preview all of your answers before quitting!</p>
                <p>All answers seen below has been read directly from the database. If something is wrong, then contact the invigilator immediately. Please <a href="<?= $this->url->get('auth/logout') ?>">sign out</a> and close all opened browser windows once you are satisfied with your answers.</p>
            </div>
            <div style="position: fixed; z-index: 5000; bottom: 0px; left:30%">
                <a class="sync-answer" href="#" hlink="<?= $this->url->get('auth/logout') ?>">
                    <button class="btn btn-xs btn-success btn-prev" style="height: 42px; font-size:15px"><i class="icon-check"></i> I have previewed all my answers here and I am satisfied. Quit my exam.</button>
                </a>
            </div>        
    <?php endif; ?>

    <?php
    // 
    // This is a mess: The $quest parameter is sometimes an object and sometimes an array depending 
    // on from where the view is used :-( (AL).
    // 
    $qSize = count($quest);
    $questionNo = 0;

    foreach ($quest as $qKey => $qObj):
            if (!$qObj->id) {
                    continue;
            }

            // calculate question number
            $prevQuestId = $nextQuestId = 0;
            if (count($quest) == 1):
                    foreach ($questions as $questionNo => $qTmp):
                            if ($qTmp->id == $qObj->id):
                                    $prevQuestId = isset($questions[$questionNo - 1]) ? $questions[$questionNo - 1]->id : 0;
                                    $nextQuestId = isset($questions[$questionNo + 1]) ? $questions[$questionNo + 1]->id : 0;
                                    break;
                            endif;
                    endforeach;
            endif;

            $questionNo++;

            $qParts = json_decode($qObj->quest, true);
            $answerData = json_decode($answer[$qObj->id]->answer, true);

            ?>
            <!-- question content row -->
            <div class="row" style="margin-top:15px">

                <div class="col-sm-12">
                    <div class="box bordered-box blue-border">
                        <div class="box-content box-double-padding" style="font-family:verdana; <?= $viewMode == 'all' ? 'border-bottom: 10px solid #BE2435' : '' ?>">
                            <i class="q-no icon-q<?= $questionNo ?> text-contrast">:</i>
                            <?php $partCount = 1; ?>
                            <?php foreach ($qParts as $qPart => $qPartData): ?>

                                    <?php if (count($qParts) > 1): ?>
                                            <span class="q-part-title"><?= $qPart ?>.</span>                                        	
                                    <?php endif; ?>

                                    <?php if ($qPartData['q_points']) : ?>
                                            <span class="q-part-pts" style="font-weight:bold; <?= $qPart == 'a' ? 'border-radius: 0 0 5px' : '' ?>"><?= floatval($qPartData['q_points']) ?> pt.</span>
                                    <?php endif; ?>

                                    <div style="margin-bottom: 0;" class="form q-part" data-id="<?= $qPart ?>" >
                                        <fieldset>
                                            <div class="q-part-ans-area col-sm-7 col-sm-offset-1" <?= !count($qPartData['resources']) ? 'style="width:100%"' : '' ?>>
                                                <div class="q-part-text" style="padding-bottom:10px">
                                                    <label><?= $qPartData['q_text'] ?></label>
                                                </div>

                                                <?php if ($viewMode == 'all'): ?>

                                                        <?php if (is_array($qPartData['ans_area']['data']) && count($qPartData['ans_area']['data'])): ?>
                                                                <div>
                                                                    <ul>
                                                                        <?php foreach ($qPartData['ans_area']['data'] as $qPartOpt => $ans): ?>
                                                                                <li><?= $qPartOpt ?></li>
                                                                        <?php endforeach; ?>
                                                                    </ul>
                                                                </div>                                                                        
                                                        <?php endif; ?>

                                                        <div style="color:#F45956; padding-top:15px">Your Answer:</div>
                                                        <?php if (!empty($answerData[$qPart]['ans'][0])): ?>
                                                                <div style="background-color:#F4F4F4; border-left: 5px solid #dedede; padding:10px">
                                                                    <?php if (count($answerData[$qPart]['ans']) > 1): ?>
                                                                            <ul>
                                                                                <?php foreach ($answerData[$qPart]['ans'] as $optAns): ?>
                                                                                        <li><?= $optAns ?></li>
                                                                                <?php endforeach; ?>
                                                                            </ul>
                                                                    <?php else: ?>
                                                                            <?php if ($answerData[$qPart]['type'] == 'canvas'): ?>
                                                                                    <img class="img-zoom-inner" src="<?= $answerData[$qPart]['ans'][0]['canvasUrl'] ?>" data-zoom-image="<?= $answerData[$qPart]['ans'][0]['canvasUrl'] ?>" style="max-width:100%; background-color:#f4f4f4" />
                                                                            <?php else: ?>
                                                                                    <?= $answerData[$qPart]['ans'][0] ?>
                                                                            <?php endif; ?>
                                                                    <?php endif; ?>
                                                                </div>
                                                        <?php else: ?>
                                                                <i>You haven't answered this part.</i>
                                                        <?php endif; ?>
                                                <?php else: ?>
                                                        <div class="form-group q-part-ans-type" data-id="<?= $qPartData['ans_area']['type'] ?>">
                                                            <?php if ($qPartData['ans_area']['type'] == 'textbox'): ?>
                                                                    <div id="ansBkp<?= $qPart ?>" style="display:none"><?= htmlentities($answerData[$qPart]['ans'][0]) ?></div>
                                                                    <input type="text" style="font-size:11px" class="form-control changeable" value="<?= htmlentities($answerData[$qPart]['ans'][0]) ?>" placeholder="Write your answer here ..." />
                                                            <?php elseif ($qPartData['ans_area']['type'] == 'canvas'): ?>
                                                                    <?php $drawingJson = trim(json_encode($answerData[$qPart]['ans'][0]['canvasJson']), '"'); ?>
                                                                    <div id="s<?= $student->id ?>q<?= $qObj->id ?>p<?= $qPart ?>" class="literally changeable"></div>
                                                                    <button class="fullscreen" isfor="s<?= $student->id ?>q<?= $qObj->id ?>p<?= $qPart ?>">Fullscreen</button>    
                                                                    <script language="javascript">initCanvas('s<?= $student->id ?>q<?= $qObj->id ?>p<?= $qPart ?>', <?= $drawingJson != 'null' ? '"' . $drawingJson . '"' : 'null' ?>);</script>
                                                            <?php elseif ($qPartData['ans_area']['type'] == 'choicebox'): ?>
                                                                    <?php $type = (count(array_filter($qPartData['ans_area']['data'])) == 1) ? 'radio' : 'checkbox'; ?>
                                                                    <div class="col-md-10">
                                                                        <?php $i = 0; ?>
                                                                        <?php foreach ($qPartData['ans_area']['data'] as $qPartOpt => $ans): ?>
                                                                                <div class="checkbox">
                                                                                    <label>
                                                                                        <input <?= $type == 'radio' ? 'name="' . $questionNo . '-' . $qPart . '"' : '' ?> type="<?= $type ?>" value="<?= htmlspecialchars($qPartOpt) ?>" class="changeable" <?= isset($answerData[$qPart]['ans']) && in_array($qPartOpt, $answerData[$qPart]['ans']) ? 'checked="checked"' : '' ?>>
                                                                                        <?= $qPartOpt ?>
                                                                                    </label>
                                                                                </div>
                                                                                <?php $i++; ?>
                                                                        <?php endforeach; ?>
                                                                    </div>                                                                        
                                                            <?php else: ?>
                                                                    <div id="ansBkp<?= $qPart ?>" style="display:none"><?= $answerData[$qPart]['ans'][0] ?></div>
                                                                    <textarea id="q-<?= $questionNo ?>_part-<?= $qPart ?>" class="form-control changeable ckeditor" word-count-limit="<?= $qPartData['ans_area']['word_count'] ?>" native-spell-check="<?= $qPartData['ans_area']['spell_check'] ?>"><?= $answerData[$qPart]['ans'][0] ?></textarea>
                                                            <?php endif; ?>
                                                        </div>
                                                <?php endif; ?>
                                            </div>
                                            <?php if (count($qPartData['resources'])): ?>
                                                    <div class="q-part-resource-area col-sm-2">
                                                        <div class="box">
                                                            <div class="lead" style="font-size:15px"> 
                                                                <i class="icon-file-text-alt text-contrast resource-file" style="cursor: pointer" title="Hide resource files"></i> Supplementary material 
                                                            </div>
                                                            <?php foreach ($qPartData['resources'] as $resTitle => $resUrl) : ?>
                                                                    <div class="resource-file-box" style="margin-bottom: 10px; border-radius: 3px; width: 330px; padding: 5px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 5px 20px 0 rgba(0, 0, 0, 0.2);">
                                                                        <?php
                                                                        $type = basename(dirname($resUrl));
                                                                        $path = $this->config->application->mediaDir . $type . DIRECTORY_SEPARATOR . basename(urldecode($resUrl));
                                                                        $href = $this->url->get($resUrl);

                                                                        if (file_exists($path)) {
                                                                                $mime = mime_content_type($path);
                                                                                $type = explode("/", $mime);
                                                                        } else {
                                                                                $mime = "application/octet-stream";
                                                                                $type = explode("/", $mime);
                                                                        }

                                                                        switch ($type[0]) {
                                                                                case 'audio':
                                                                                        $icon = 'file-audio-o';
                                                                                        $desc = 'Download audio file';
                                                                                        break;
                                                                                case 'video':
                                                                                        $icon = 'file-video-o';
                                                                                        $desc = 'Download video file';
                                                                                        break;
                                                                                case 'image':
                                                                                        $icon = 'file-image-o';
                                                                                        $desc = 'Download image file';
                                                                                        break;
                                                                                case 'application':
                                                                                        switch ($type[1]) {
                                                                                                case 'pdf':
                                                                                                        $icon = 'file-pdf-o';
                                                                                                        $desc = 'Download PDF';
                                                                                                        break;
                                                                                                case 'vnd.oasis.opendocument.spreadsheet':
                                                                                                case 'octet-stream':
                                                                                                case 'vnd.ms-office':
                                                                                                        $icon = 'file-excel-o';
                                                                                                        $desc = 'Download spreadsheet';
                                                                                                        break;
                                                                                                case 'vnd.openxmlformats-officedocument.wordprocessingml.document':
                                                                                                case 'vnd.oasis.opendocument.text':
                                                                                                case 'msword':
                                                                                                        $icon = 'file-word-o';
                                                                                                        $desc = 'Download text document';
                                                                                                        break;
                                                                                                case 'vnd.openxmlformats-officedocument.presentationml.presentation':
                                                                                                case 'vnd.oasis.opendocument.presentation':
                                                                                                case 'vnd.ms-powerpoint':
                                                                                                        $icon = 'file-powerpoint-o';
                                                                                                        $desc = 'Download presentation';
                                                                                                        break;
                                                                                                case 'zip':
                                                                                                case 'x-gzip':
                                                                                                case 'java-archive':
                                                                                                        $icon = 'file-archive-o';
                                                                                                        $desc = 'Download archive file';
                                                                                                        break;
                                                                                        }
                                                                                        break;
                                                                        }

                                                                        ?>
                                                                        <?php if ($type[0] == 'video') : ?>
                                                                                <video
                                                                                    id="my-player"
                                                                                    class="video-js"
                                                                                    controls
                                                                                    preload="auto"
                                                                                    poster="<?= $this->url->get('img/pexels-photo-318540-video.jpeg') ?>"
                                                                                    width="320" height="240"
                                                                                    data-setup='{}'>
                                                                                    <source src="<?= $href ?>" type="<?= $mime ?>"></source>
                                                                                    <p class="vjs-no-js">
                                                                                        To view this video file please enable JavaScript, and consider upgrading to a
                                                                                        web browser that
                                                                                        <a href="http://videojs.com/html5-video-support/" target="_blank">
                                                                                            supports HTML5 video/audio
                                                                                        </a>
                                                                                    </p>
                                                                                </video>
                                                                        <?php elseif ($type[0] == 'audio') : ?>
                                                                                <audio
                                                                                    id="my-player"
                                                                                    class="video-js"
                                                                                    controls
                                                                                    preload="auto"
                                                                                    poster="<?= $this->url->get('img/pexels-photo-144429-audio.jpeg') ?>"
                                                                                    width="320" height="240"
                                                                                    data-setup='{}'>
                                                                                    <source src="<?= $href ?>" type="<?= $mime ?>"></source>
                                                                                    <p class="vjs-no-js">
                                                                                        To listen to this audio file please enable JavaScript, and consider upgrading to a
                                                                                        web browser that
                                                                                        <a href="http://videojs.com/html5-video-support/" target="_blank">
                                                                                            supports HTML5 audio/audio
                                                                                        </a>
                                                                                    </p>
                                                                                </audio>
                                                                        <?php else : ?>
                                                                                <div>
                                                                                    <a class="fancybox" rel="fancybox" href="<?= $href ?>" title="<?= $resTitle ?>">
                                                                                        <?php if ($type[0] == "image"): ?>
                                                                                                <img style="max-width:320px" class="img-zoom" src='<?= $href ?>' data-zoom-image="<?= $href ?>"/>
                                                                                        <?php else: ?>
                                                                                                <a class="media {width:320}" href="<?= $href ?>"></a> 
                                                                                        <?php endif; ?>
                                                                                    </a>    
                                                                                </div>
                                                                        <?php endif; ?>

                                                                        <div style="padding: 5px">
                                                                            <a href="<?= $href ?>" title="<?= $desc ?>" style="text-decoration: none">
                                                                                <small class="text-muted" style="vertical-align: central">
                                                                                    <i class="fa fa-<?= $icon ?> fa-2x"></i> 
                                                                                    <?= $resTitle ?>
                                                                                </small> <br />
                                                                            </a>
                                                                        </div>
                                                                    </div>

                                                            <?php endforeach; ?>
                                                        </div>
                                                    </div>                                            
                                            <?php endif; ?>            
                                        </fieldset>
                                        <?php if ($partCount++ != count($qParts)): ?>
                                                <hr class="q-part-seprator hr-normal" />
                                        <?php endif; ?>
                                    </div>
                            <?php endforeach; ?>

                            <div style="margin:0px 15px " class="actions">
                                <div class="row q-actions">
                                    <?php if ($viewMode == 'single'): ?>
                                            <div style="padding-bottom:25px">
                                                <label style="font-weight:normal">
                                                    <input type="checkbox" id="highlight_q" value="1" class="changeable" <?= $answerData['highlight-q'] == 'yes' ? 'checked' : '' ?> <?= $testMode ? 'disabled' : '' ?>>
                                                    <span style="font-size:14px">I would like to review my answer for this question later on, so mark it.</span>
                                                </label>
                                            </div>
                                            <?php if ($prevQuestId && $prevQuestId != $qObj->id): ?>
                                                    <a class="sync-answer" href="#" hlink="<?= $this->url->get('exam/' . $exam->id . '/question/' . ($prevQuestId)) ?>">
                                                        <button class="btn btn-xs btn-prev"><i class="icon-arrow-left"></i> Prev. Question </button>
                                                    </a>
                                            <?php endif; ?>

                                            <?php if ($nextQuestId): ?>
                                                    <a class="sync-answer" href="#" hlink="<?= $this->url->get('exam/' . $exam->id . '/question/' . ($nextQuestId)) ?>">
                                                        <button class="btn btn-xs btn-success btn-next"> Next Question <i class="icon-arrow-right"></i></button>
                                                    </a>
                                            <?php else: ?>
                                                    <a class="sync-answer" href="#" hlink="<?= $this->url->get('exam/' . $exam->id . '/question/all') ?>">
                                                        <button class="btn btn-xs btn-success btn-next"><i class="icon-list"></i> Preview your answers for all questions</button>
                                                    </a>
                                            <?php endif; ?>
                                    <?php else: ?>
                                            <a href="<?= $this->url->get('exam/' . $exam->id . '/question/' . ($qObj->id)) ?>">
                                                <button class="btn btn-xs btn-success btn-prev"><i class="icon-pencil"></i> Change your Answer for this question </button>
                                            </a>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    </div>        

                </div>
            </div>
            <?php
            if ($qSize == 1) {
                    break;
            }
    endforeach;

    ?>
</div>

<div class="ans-sync-msg">Saving ... </div>
<div id="exam-instructions" class="hero-unit" style="min-width:800px; display:none; font-family:Verdana, Geneva, sans-serif;">
    <div class="head"><?= Phalcon\Tag::image(array("img/uu_logo.svg", "height" => "55px", "style" => "padding-right:20px")); ?>
        <span style="color: #c2100c">Exam instructions: <?= $exam->name ?></span>
    </div>
    <?= $exam->descr ?>
</div>
<div id="general-instructions" class="hero-unit" style="min-width:800px; display:none; font-family:Verdana, Geneva, sans-serif;">
    <div class="head"><?= Phalcon\Tag::image(array("img/uu_logo.svg", "height" => "55px", "style" => "padding-right:20px")); ?>
        <span style="color: #c2100c">General exam instructions: <?= $exam->name ?></span>
    </div>
    <div>
        <div style="padding-bottom:10px">
            Use the buttons in the heading to minimize the left pane or increase the text size 
            Under Exam info. You may again read the instructions, access a preview of all your answers and log out when you are done. 
            <!--If you find it helpful, you can mark all questions as completed (green), in need of revision  (yellow) or will not be answered (red). -->
            You can hover over images (in supplementary material) to zoom. You can see full size image by clicking on it.
        </div>
        <div style="padding-bottom:10px">
            <br />
            <strong>Important to know:</strong><br />
            <ul>
                <li>All your answers are automatically saved, every 10 seconds.</li>
                <li>It is highly recomended that you <u>don't</u> use "back" and "forward" buttons of web browser to go from one question to another. Always click on <button class="btn btn-xs btn-success" disabled="disabled"> Next Question <i class="icon-arrow-right"></i></button> and <button class="btn btn-xs" disabled="disabled"><i class="icon-arrow-left"></i> Prev. Question </button> buttons. To open a specific question, you can always click on desired question number appearing in left side menu.</li>
                <li>Please report to invigilator immediately if any button or link do not work. In such a case, please don't close/refresh web browser otherwise we may loose your answer. If you see any error message from system, it is highly important that you <u>don't</u> refresh/close the web page before you report. </li>
                <li>Flip down the screen if you go away for a biological break.</li>
                <li>If you have drawing canvas in a quesiton, don't try to write text in canvas by drawing.</li>
            </ul>
        </div>
    </div>
</div>

<?= Phalcon\Tag::javascriptInclude('js/jquery.media.js'); ?>
<?= Phalcon\Tag::javascriptInclude('js/jquery.elevatezoom.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/ckeditor/ckeditor.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/ckeditor/adapters/jquery.js'); ?>

<script language="javascript" type="text/javascript">
<?php if (!$testMode && $viewMode == 'single'): ?>
                var qName = '<?= $questionNo ?>';
                var ansId = '<?= $answer[$qObj->id]->id ?>';
                if (ansId == '') {
                    alert("System will not be able to save your answer for this question. Please report this issue to exam invigilators immediately.")
                }
<?php else: ?>
                var ansId = 'None!';
<?php endif; ?>
        var count = <?= (strtotime($exam->starttime) - strtotime("now")) ?>;
        setInterval(function () {
            $('.cke_button__maximize').hide();
        }, 350);
</script> 
