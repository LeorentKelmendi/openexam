<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery-ui.css'); ?>
<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery.ui.autocomplete.css'); ?>
<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery.ui.timepicker.css'); ?>
<?= Phalcon\Tag::stylesheetLink('plugins/validation/css/validationEngine.jquery.css'); ?>
<?= Phalcon\Tag::stylesheetLink('css/opentip.css'); ?>

<?= Phalcon\Tag::javascriptInclude('js/opentip-jquery.min.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/jquery-ui.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/ui/jquery-ui-timepicker.js'); ?>
<?= Phalcon\Tag::javascriptInclude('js/modernizr.js') ?>
<?= Phalcon\Tag::javascriptInclude('plugins/ckeditor/ckeditor.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/ckeditor/adapters/jquery.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/validation/js/languages/jquery.validationEngine-en.js') ?>
<?= Phalcon\Tag::javascriptInclude('plugins/validation/js/jquery.validationEngine.js') ?>

<?= Phalcon\Tag::javascriptInclude('js/views/exam/create.js'); ?>
<?= Phalcon\Tag::javascriptInclude('js/views/exam/security.js'); ?>
<?= Phalcon\Tag::javascriptInclude('js/views/exam/check.js'); ?>

<?php

use OpenExam\Library\Core\Exam\Check;

?>

<?php $examQs = $exam->getQuestions(array("order" => "slot")); ?>

<!-- Left Column -->
<?php $this->partial("exam/shared/left-menu", array('exam' => $exam)) ?> 

<!-- Main area -->         
<?php $canUpdateExam = $this->capabilities->hasCapability($exam, 'update'); ?>
<div id="container" class="left_menu_space" style="">

    <div id="breadcrumbsRow">
        <?php if ($exam->published): ?>
                <?= Phalcon\Tag::image(array("img/published.gif", "style" => "z-index: 0; height: 65px; position: relative; float: right; top: -9px;")); ?>
        <?php endif; ?>
    </div>

    <div id="centerColWide">

        <? /* --Exam title and description-- */ ?>

        <h1>
            <?= trim($exam->name) != '' ? $exam->name : 'Untitled exam' ?>
            <?php if ($canUpdateExam) : ?>
                    <a href="#" class="prevent exam-settings">
                        <i class="fa fa-gear" id="exam-settings" style="float:right;padding:3px"></i>
                    </a> 
                    <a href="#" class="prevent exam-security">
                        <i class="fa fa-lock" id="exam-security" style="float:right;padding:3px"></i>
                    </a>                
                    <a href="#" class="prevent exam-check">
                        <i class="fa fa-check-square" id="exam-check" style="float:right;padding:3px"></i>
                    </a>                
            <?php endif; ?>
        </h1>

        <?php if ($canUpdateExam && $status != Check::STATUS_IS_READY) : ?>
                <div style="float: left">
                    <?php if ($status == Check::STATUS_NEED_ATTENTION) : ?>
                            <i class="fa fa-2x fa-exclamation-circle" style="color: blue"></i>
                            <span style="vertical-align: top">Suggested task: 
                        <?php elseif ($status == Check::STATUS_NOT_READY) : ?>
                                <i class="fa fa-2x fa-exclamation-circle" style="color: red"></i>
                                <span style="vertical-align: top">Remaining task: 
                            <?php endif; ?>
                            <?php
                            switch ($task) {
                                    case Check::TASK_ADD_QUESTIONS:
                                            echo "Add questions";
                                            break;
                                    case Check::TASK_ADD_STUDENTS:
                                            echo "Add students";
                                            break;
                                    case Check::TASK_ALL_COMPLETED:
                                            echo "Exam is ready for use";
                                            break;
                                    case Check::TASK_PUBLISH_EXAM:
                                            echo "Publish exam";
                                            break;
                                    case Check::TASK_SET_NAME:
                                            echo "Set exam name";
                                            break;
                                    case Check::TASK_SET_SECURITY:
                                            if ($security == Check::SECURITY_NONE) {
                                                    echo "Set exam security";
                                            } elseif (($security & Check::SECURITY_LOCKDOWN) == 0) {
                                                    echo "Set exam lockdown";
                                            } elseif (($security & Check::SECURITY_LOCATION) == 0) {
                                                    echo "Set exam location";
                                            }
                                            break;
                                    case Check::TASK_SET_STARTTIME:
                                            echo "Set exam start time";
                                            break;
                            }

                            ?>
                        </span>
                </div>
        <?php endif; ?>

        <?php if ($this->capabilities->hasPermission($this->user->getPrimaryRole(), 'question', 'create') && in_array("contributable", $exam->flags)): ?>
                <a href="#" style="font-size: 12px; float:right" class="add_new_qs">
                    <div style="display: block; float:right">
                        <span class="btn btn-success" style="padding:2px; font-size:11px">
                            <i class="fa fa-plus-circle"></i>
                            <span>Add a new question</span>
                        </span>
                    </div>                        
                </a>
        <?php endif; ?>

        <? /* --seprator-- */ ?>
        <div class="seprator" style="border-bottom:0px">&nbsp;</div>

        <? /* --Questions area-- */ ?>
        <div id="qs_area">

            <? /* --default message when there are no questions-- */ ?>
            <div id="default_msg_qs">
                There are no questions in this exam yet. <br>
            </div>

            <? /* --Question lines-- */ ?>
            <!-- question line template -->
            <div class="qs_area_line" q-id="" q-no="" style="display:none">
                <div class="qs_area_line_q_no">
                    <div class="q_no"></div>
                    <div class="q_score"></div>
                    <div class="q_line_op">
                        <?php if (in_array("published", $exam->flags)) { ?>
                                <a href="#" class="view-q"><i class="fa fa-eye" style="color:#008803"></i></a>
                                <a href="#" class="edit-q"><i class="fa fa-pencil" style="color:#994276"></i></a>
                        <?php } else { ?>
                                <a href="#" class="view-q"><i class="fa fa-eye" style="color:#008803"></i></a>
                                <a href="#" class="edit-q"><i class="fa fa-pencil" style="color:#004276"></i></a>
                                <a href="#" class="del-q"><i class="fa fa-close"></i></a>
                        <?php } ?>
                    </div>
                </div>
                <div class="qs_area_line_q_parts" style="padding-left: 10px">
                    <div class="qs_area_line_q" style="display:none">
                        <div class="q_head">
                            <div style="padding-bottom:5px">
                                <span class="q_part_no" style="font-size:16px; padding-right:0px"></span>
                                <span class="q_part_pt" style="color:grey; font-size:10px"></span>
                            </div>
                            <span class="q_title"></span>
                        </div>
                        <div class="q_fields" style="width:70%; float:left"></div>
                        <br style="clear:both"/>
                    </div>
                </div>   
            </div>   
        </div>

        <?php if ($canUpdateExam && in_array("editable", $exam->flags)): ?>
                <div id="exam_op_btns" style="padding:15px; <?= !count($examQs) ? 'display:none' : '' ?>">
                    <center>
                        <a href="<?= $this->url->get('exam/' . $exam->id) ?>">
                            <span class="btn btn-default" style="font-size:11px; color:#333333">
                                <i class="fa fa-chevron-circle-right"></i>
                                <span>Preview student view</span>
                            </span>
                        </a>
                    </center>
                </div>

        <?php elseif ($this->capabilities->hasPermission($this->user->getPrimaryRole(), 'question', 'create') && in_array("editable", $exam->flags)): ?>
                <a href="<?= $this->url->get('exam/index'); ?>">
                    <div id="" style="margin-bottom: 10px">
                        <center>
                            <span class="btn btn-success">
                                <i class="fa fa-chevron-circle-right"></i>
                                <span>I am done with my questions. Notify exam creator.</span>
                            </span>
                        </center>
                    </div>
                </a>
        <?php endif; ?>

        <!-- centerColWide --> 
    </div>
    <br clear="both">
    <!-- container --> 
</div>

<!--------------- Hidden Divs ----------------->     
<!-- Add / Edit question form that appears in light box -->
<div id="question-form-dialog-wrap" q-no="" style="display:none" title=""></div>

<!-- Student management form -->
<div id="manage-students" title="Manage students for exam" style="display:none"></div>

<!-- Exam settings -->
<div id="exam-settings-box" style="display:none" title="Exam settings" ></div>

<!-- Exam security -->
<div id="exam-security-box" style="display:none" title="Security and access control" ></div>

<!-- Exam status check -->
<div id="exam-check-box" style="display:none" title="Exam status check" ></div>

<?php
// combine question json to initialize exam
$combinedJson = array();
$questionNo = 1;
foreach ($examQs as $qData) {

        // add questId node
        $qJson = json_decode($qData->quest, true);
        $qJson['questId'] = $qData->id;
        $qJson['canUpdate'] = 1;

        $combinedJson[$questionNo++] = $qJson;
}
$combinedJson = (!count($combinedJson) ? "JSON.parse('{}')" : json_encode($combinedJson));

?>
<script language="javascript">
        var mngr = '<?= $exam->creator ?>';
        var user = '<?= $this->user->getPrincipalName() ?>';
        var mode = '<?= $mode ?>';
        var role = '<?= $role ?>';
        var examId = <?= $exam->id ?>;
        var qsJson = <?= $combinedJson ?>;
        var qsCorrectorsJson = {};
        var showAddQuestionView = <?= stristr($_SERVER['REQUEST_URI'], 'add-q') ? 'true' : 'false' ?>;
        var isNewExam = <?= stristr($_SERVER['REQUEST_URI'], 'new-exam') ? 'true' : 'false' ?>;
</script>
