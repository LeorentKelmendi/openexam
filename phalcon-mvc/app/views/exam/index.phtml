<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery-ui.css'); ?>
<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery.ui.timepicker.css'); ?>
<?= Phalcon\Tag::stylesheetLink('css/opentip.css'); ?>

<?= Phalcon\Tag::javascriptInclude('js/opentip-jquery.min.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/jquery-ui.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/ui/jquery-ui-timepicker.js'); ?>
<?= Phalcon\Tag::javascriptInclude('js/views/exam/index.js') ?>

<?php

use OpenExam\Library\Security\Roles;

/**
 * Define page sections and section operations along with exam state based permissions
 * @ToDO: move to config file
 */
$sections = array(
        Roles::CREATOR               => array(
                'title'        => 'Creator - create and manage an exam',
                'show-options' => array(
                        'del-exam'    => array(
                                'target'        => 'del-exam',
                                'show-on-flags' => array(
                                        "deletable",
                                )
                        ),
                        'reuse-exam'  => array(
                                'target'        => 'reuse-exam',
                                'show-on-flags' => array(
                                        '*'
                                )
                        ),
                        'test-exam'   => array(
                                'target'        => 'exam/{exam-id}',
                                'show-on-flags' => array(
                                        "contributable"
                                )
                        ),
                        'view-exam'   => array(
                                'target'        => 'exam/{exam-id}/question/all',
                                'show-on-flags' => array(
                                        "published"
                                )
                        ),
                        'manage-exam' => array(
                                'target'        => 'exam/update/{exam-id}/creator',
                                'show-on-flags' => array(
                                        "*"
                                )
                        ),
                /* 'view-exam' => array(
                  'target'=> 'exam/update/{exam-id}/creator',
                  'show-on-flags' => array (
                  "running",
                  "finished"
                  )
                  ), */
                )
        ),
        Roles::CONTRIBUTOR           => array(
                'title'        => 'Contributor - add questions to an exam',
                'show-options' => array(
                        'add-q'     => array(
                                'target'        => 'exam/update/{exam-id}/contributor/add-q',
                                'show-on-flags' => array(
                                        "contributable"
                                )
                        ),
                        'view-exam' => array(
                                'target'        => 'exam/update/{exam-id}/contributor',
                                'show-on-flags' => array(
                                        '*'
                                )
                        )
                )
        ),
        Roles::INVIGILATOR           => array(
                'title'        => 'Invigilator',
                'show-options' => array(
                        'change-time'    => array(
                                'target'        => 'change-time',
                                'show-on-flags' => array(
                                        "examinatable"
                                )
                        ),
                        'manage-student' => array(
                                'target'        => 'manage-students',
                                'show-on-flags' => array(
                                        "examinatable"
                                )
                        ),
                        'finished-exam'  => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                        "finished"
                                )
                        )
                )
        ),
        Roles::CORRECTOR             => array(
                'title'        => 'Corrector - correct the student\'s answers',
                'show-options' => array(
                        'download-result'   => array(
                                'target'        => 'exam/{exam-id}/correction/download-result',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'view-scoreboard'   => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'ans-correction'    => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "correctable"
                                )
                        ),
                        'exam-not-finished' => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                        "upcoming",
                                        "running",
                                )
                        ),
                )
        ),
        Roles::DECODER               => array(
                'title'        => 'Decoder - view and decode results',
                'show-options' => array(
                        'download-result' => array(
                                'target'        => 'exam/{exam-id}/correction/download-results',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'view-scoreboard' => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "correctable",
                                        "decodable",
                                        "decoded"
                                )
                        ),
                        'decode-exam'     => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "decodable"
                                )
                        ),
                        'decode-closed'   => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                /* "contributable",
                                  "running",
                                  "correctable" */
                                )
                        ),
                )
        ),
        Roles::STUDENT . '-upcoming' => array(
                'title'        => 'Your upcoming/ongoing exams',
                'show-options' => array(
                        'st-exam-page' => array(
                                'target'        => 'exam/{exam-id}',
                                'show-on-flags' => array(
                                        "*"
                                /* "upcoming", 
                                  "running" */
                                )
                        )
                )
        ),
        Roles::STUDENT . '-finished' => array(
                'title'        => 'Your finished exams',
                'show-options' => array(
                        'download-result'    => array(
                                'target'        => 'result/{exam-id}/download',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'st-exam-correction' => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                        "correctable"
                                )
                        )
                )
        ),
);

$opButtonsHtml = array(
        'manage-exam'        => '<span class="label label-green"><i class="fa fa-gear"></i> Manage</span>',
        'test-exam'          => '<span class="label label-blue"><i class="fa fa-thumbs-o-up"></i> Test exam</span>',
        'del-exam'           => '<span class="label label-red"><i class="fa fa-trash"></i> Delete</span>',
        'reuse-exam'         => '<span class="label label-primary" style="background-color: #4285F4"><i class="fa fa-refresh"></i> Reuse</span>',
        'view-exam'          => '<span class="label label-green"><i class="fa fa-question-circle"></i> View exam</span>',
        'add-q'              => '<span class="label label-blue"><i class="fa fa-pencil-square-o"></i> Add questions</span>',
        'ans-correction'     => '<span class="label label-green"><i class="fa fa-check-square-o"></i> Answer correction</span>',
        'exam-not-finished'  => '<span class="label label-primary"><i class="fa fa-times"></i> Exam not finished yet</span>',
        'view-results'       => '<span class="label label-warning"><i class="fa fa-line-chart"></i> View results</span>',
        'view-scoreboard'    => '<span class="label label-warning"><i class="fa fa-trophy"></i> View Score board</span>',
        'download-result'    => '<span class="label label-primary" style="background-color: #4285F4"><i class="fa fa-download"></i> Download results</span>',
        'decode-exam'        => '<span class="label label-green"><i class="fa fa-code"></i> Decode this exam</span>',
        'decode-closed'      => '<span class="label label-primary"><i class="fa fa-times"></i> Not open for decoding yet</span>',
        'finished-exam'      => '<span class="label label-primary"><i class="fa fa-times"></i> Finished exam</span>',
        'manage-student'     => '<span class="label label-green"><i class="fa fa-user"></i> Manage students</span>',
        'change-time'        => '<span class="label label-blue"><i class="fa fa-clock-o"></i> Change schedule</span>',
        'st-exam-page'       => '<span class="label label-green"><i class="fa fa-gear"></i> Go to exam page</span>',
        'st-view-exam'       => '<span class="label label-green"><i class="fa fa-gear"></i> View exam</span>',
        'st-exam-correction' => '<span class="label label-primary"><i class="fa fa-times"></i> Exam correction going on</span>',
);

$examsPerPage = 5;

?>

<div id="container" class="left_menu_space container" style="width:100%">

    <div class="hero-unit" style="margin:15px">
        <h1>Hej <?= explode(" ", $this->helper->getCatalogAttribute($this->user->getPrincipalName(), 'name'))[0] ?>!</h1>
        <div style="padding:10px 0px">
            The content of this page depends on your level of access (‘role’) in OpenExam. 
            Information about the different roles (creator, contributor, corrector, invigilator, student) can be found <a href="#">here</a>.  
        </div>
        <div style="padding-bottom:5px">
            If you do not yet have full access, but would like to create your own online exam, <a href="#">contact us</a>.
        </div>
        <div>
            Consult <a href="#">Help</a> for information on how to use OpenExam.
        </div>
    </div>
    <section class="ac-container">
        <?php $sectId = 1; ?>
        <?php foreach ($roleBasedExamList as $role => $exams) : ?>
                <?php if ($role != Roles::CREATOR && !count($exams)) continue; ?>
                <div>
                    <input id="ac-<?= $sectId ?>" name="accordion-1" type="radio"/>
                    <label for="ac-<?= $sectId ?>" class="exam-list-boxes">
                        <i class="fa fa-chevron-right chevron" style="font-size: 16px; color: #990000"></i>
                        <?= $sections[$role]['title'] ?>
                    </label>
                    <?php $title = str_replace(" ", "_", $sections[$role]['title']); ?>
                    <article class="ac-large exam-listing-wrapper" data-id="<?= $title ?>" exam-role="<?= (stristr($role, Roles::STUDENT) ? Roles::STUDENT : $role) ?>" section-role="<?= $role ?>">
                        <?php if ($role == Roles::CREATOR): ?>
                                <a href="<?= $this->url->get('exam/create') ?>"> 
                                    <span style="float: right; font-size: 12px;"> 
                                        <span class="label label-blue" style="margin-right: 26px; background-color:#3D7489">
                                            <i class="fa fa-plus-square"></i> Create a new exam
                                        </span> 
                                    </span> 
                                </a>
                        <?php endif; ?>

                        <?php $totalExams = count($exams); ?>
                        <?php if ($totalExams): ?>
                                <?php if ($totalExams > $examsPerPage): ?>
                                        <div style="float:right; padding:5px;">
                                            <input type="text" class="exam-search-box" placeholder="Quick search for exams as exam <?= (stristr($role, Roles::STUDENT) ? Roles::STUDENT : $role) ?>">
                                            <span class="label label-orange search-exam"><i class="fa fa-search" style="color:#FFF"></i></span> 
                                        </div>
                                <?php endif; ?>
                                <div>
                                    <div class="exam-listing-area" style="min-height:400px">
                                        <ul class="list-group exam-list">
                                            <?php //if($totalExams > $examsPerPage): ?>
                                            <li class="list-group-item" style="background-color: rgb(245, 245, 245); padding: 5px; font-size: 11px;">
                                                <span style="font-size:9px">Sort by: </span>
                                                <select class="exam-sort-by" style="font-size: 9px; height: 20px; width: 95px;">
                                                    <option value="created">Date created</option>
                                                    <option value="name">Exam title</option>
                                                    <option value="code">Exam code</option>
                                                    <option value="starttime">Exam starts</option>                                                        
                                                </select>
                                                <i class="fa fa-arrow-circle-down fa-lg exam-sort-order" order="desc" style="color: rgb(193, 0, 43);"></i>
                                            </li>
                                            <?php //endif;?>
                                            <?php $count = 1; ?>
                                            <?php foreach ($exams as $exam): ?>
                                                    <li class="list-group-item" data-id="<?= $exam->id ?>" style=" <?= $exam->published && $role == Roles::CREATOR ? 'background-color:#ffffed' : '' ?>">
                                                        <div style="float:left"> 
                                                            <span class="exam-status">
                                                                <?php if ($role != Roles::CREATOR): ?>
                                                                        <i class="fa fa-graduation-cap"></i>
                                                                <?php else: ?>
                                                                        <i class="fa fa-check-square-o published-exam" style="color:green; <?= !$exam->published ? 'display:none' : '' ?>"></i>
                                                                        <i class="fa fa-pencil-square-o draft-exam" style="color:#666666; <?= $exam->published ? 'display:none' : '' ?>"></i>
                                                                <?php endif; ?>
                                                            </span>	
                                                            <a href="#" class="exam-name prevent" style="cursor:default">
                                                                <?= trim($exam->name) != "" ? $exam->name : 'Untitled exam' ?>
                                                                <?= !empty($exam->code) ? " (" . $exam->code . ") " : "" ?>
                                                            </a>
                                                            <span class="exam-date-time" style="font-size:10px; padding-left:15px; <?= (empty($exam->starttime) ? 'display:none' : '') ?>">
                                                                <i class="fa fa-clock-o"></i>
                                                                <span class="exam-date">
                                                                    <span><?= date("Y-m-d", strtotime($exam->starttime)); ?></span>
                                                                </span>
                                                                <span class="exam-starts"><?= date("H:i", strtotime($exam->starttime)) ?></span>
                                                                &#8594;
                                                                <span class="exam-ends"><?= !empty($exam->endtime) ? date("H:i", strtotime($exam->endtime)) : '' ?></span>
                                                            </span>


                                                            <?php /*
                                                              <div class="exam-descr" style="color: grey; font-size: 9px;">
                                                              <?=substr(strip_tags($exam->descr), 0, 120)." ...";?>
                                                              </div>
                                                             */ ?>
                                                        </div>
                                                        <div style="float:right">
                                                            <div class="exam-show-options">
                                                                <?php foreach ($sections[$role]['show-options'] as $op => $opData): ?>

                                                                        <?php $isUrl = preg_match('/.*\/.*/', $opData['target']); ?>
                                                                        <?php if ($opData['show-on-flags'][0] == '*' || count(array_diff($opData['show-on-flags'], $exam->flags)) != count($opData['show-on-flags'])) : ?>
                                                                                <?php $href = ($isUrl ? str_replace("{exam-id}", $exam->id, $opData['target']) : '#'); ?>
                                                                                <a data-id="<?= $exam->id ?>" 
                                                                                   href="<?= $this->url->get($href) ?>" 
                                                                                   class="<?= ($isUrl ? '' : $opData['target'] . ' prevent') ?>"
                                                                                   <?= (stristr($role, Roles::STUDENT)) ? 'target="_blank"' : '' ?>>
                                                                                       <?= $opButtonsHtml[$op] ?>
                                                                                </a>
                                                                        <?php endif; ?>

                                                                <?php endforeach; ?>
                                                            </div>
                                                            <div style="padding-top: 5px; float:right; clear:both; display:none">
                                                                <span class="exam-date" style="padding-right: 5px; font-size: 9px;">
                                                                    <i class="fa fa-calendar"></i>
                                                                    <span><?= date("Y-m-d", strtotime($exam->starttime)) ?></span>
                                                                </span> 
                                                                <span style="font-size: 9px;"> <i class="fa fa-clock-o"></i>
                                                                    <span class="exam-starts"><?= date("H:i", strtotime($exam->starttime)) ?></span>
                                                                    &mdash;
                                                                    <span class="exam-ends"><?= date("H:i", strtotime($exam->endtime)) ?></span>
                                                                </span> 
                                                            </div>
                                                        </div>
                                                        <div style="clear:both"></div>
                                                    </li>
                                                    <?php if ($count == $examsPerPage) break; ?>
                                                    <?php $count++; ?>
                                            <?php endforeach; ?>
                                        </ul>
                                        <?php
                                        $totalPages = ceil($totalExams / $examsPerPage);
                                        if ($totalPages > 1):

                                                ?>
                                                <div style=" float: right; left: -50%; margin-bottom: 2em; position: relative; text-align: left;">
                                                    <ul class="pagination" style="left: 50%; list-style: none outside none; margin: 0; padding: 0; position: relative;">
                                                        <!--<li class="disabled"><a href="#">«</a></li>-->
                                                        <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                                                                <li class="<?= ($i == 1) ? 'active' : '' ?>" offset="<?= (($i - 1) * $examsPerPage) ?>">
                                                                    <a href="#" style="padding:0px 9px"><?= $i ?><span class="sr-only">(current)</span></a> 
                                                                </li>
                                                        <?php endfor; ?>
                                                    </ul>
                                                </div>
                                        <?php endif; ?>
                                    </div>
                                </div>       
                        <?php else: ?>
                                <div class="exam-listing-default-msg"> 
                                    <?php if (stristr($role, Roles::STUDENT)): ?>
                                            <i class="fa fa-info-circle"></i> Currently you don't have any <?= str_replace("student-", "", $role) ?> exams.
                                    <?php else: ?>
                                            <i class="fa fa-info-circle"></i> Currently you don't have any exams as <?= $role ?>.
                                    <?php endif; ?>
                                </div>
                        <?php endif; ?>
                    </article>
                    <?php $examData = array(); ?>
                    <?php foreach ($exams as $exam): ?>
                            <?php $examData[$exam->id] = $exam->toArray(); ?>
                    <?php endforeach; ?>
                </div>
                <?php $sectId++; ?>
        <?php endforeach; ?>
        <input id="ac-hidden" type="radio" name="accordion-1">
        <label for="ac-hidden" id="ac-hidden-label" style="display:none">
            <i class="fa fa-chevron-right chevron" style="font-size: 16px; color: #990000"></i>
        </label>
        <article class="ac-large"  style="display:none">
        </article>
    </section>

    <!-- hidden divs -->
    <div id="mng-students" title="Manage students for exam" style="display:none"></div>
    <div id="reuse-exam-dialog" title="Reuse exam" style="display:none">
        <div style="margin-top:15px; margin-bottom:10px">
            Along with <strong>Exam title, instructions and exam settings</strong>, please select if any of the following exam parts you would like to reuse:
        </div>
        <div style="margin-left:25px">
            <input type="checkbox" value="topics" class="exam-reuse-opt">
            Question sections<br>
            <input type="checkbox" value="questions" class="exam-reuse-opt">
            Questions and question correctors<br>
            <input type="checkbox" value="roles"  class="exam-reuse-opt">
            Exam roles<br>
        </div>         
    </div>
    <div id="change-time" title="Change exam data and time" style="display:none">
        <h4 id="exam-title"></h4>
        <div style="margin-left:25px">
            <div  style="padding-bottom:15px">
                Examination time:
                <div>
                    <input type="text" class="timepicker" id="exam-starttime" value="" style="height:15px; width:60px" placeholder="Start time" /> 
                    &#8594;  
                    <input type="text" class="timepicker" id="exam-endtime" value="" style="height:15px; width:60px" placeholder="End time" />
                </div>         
            </div>
            <div>
                Examination date:
                <div> 
                    <input type="text" class="datepicker" id="exam-date" value="" style="height:15px; display:none" />
                </div>
            </div>
        </div>         
    </div>
    <?php foreach ($opButtonsHtml as $btnKey => $btnHtml): ?>
            <div id="<?= $btnKey ?>" style="display:none"><?= $btnHtml ?></div>
    <?php endforeach; ?>

    <!-- container -->
</div>
<script language="javascript">
        $(function () {
            $('.datepicker').datepicker({"dateFormat": "yy-mm-dd"});
            $('.timepicker').timepicker();
            $('.exam-list-boxes').click(function () {
                //alert("clicked");
                $('.chevron').removeClass('fa-chevron-down').addClass('fa-chevron-right').css('color', '#990000');
                $(this).find('.chevron').removeClass('fa-chevron-right').addClass('fa-chevron-down').css('color', '#3A87AD');
                if ($(this).parent().find('input[type="radio"]').is(':checked')) {
                    $('#ac-hidden-label').trigger('click');
                    //$(this).parent().find('input[type="radio"]').prop('checked', false);
                    //alert("triggering");
                } else {
                    console.log("not checked");
                }
            });
        });
        var examSections = <?= json_encode($sections); ?>;
        var examPerPage = <?= $examsPerPage ?>;
</script>
