<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery-ui.css'); ?>
<?= Phalcon\Tag::stylesheetLink('plugins/jqueryui/themes/blitzer/jquery.ui.timepicker.css'); ?>
<?= Phalcon\Tag::stylesheetLink('css/opentip.css'); ?>

<?= Phalcon\Tag::javascriptInclude('js/opentip-jquery.min.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/jquery-ui.js'); ?>
<?= Phalcon\Tag::javascriptInclude('plugins/jqueryui/ui/jquery-ui-timepicker.js'); ?>

<?php

use OpenExam\Library\Core\Exam\State;
use OpenExam\Library\Gui\Component\Exam\Progress;
use OpenExam\Library\Security\Roles;

/**
 * Define page sections and section operations along with exam state based permissions
 * @ToDO: move to config file
 */
$sections = array(
        Roles::CREATOR               => array(
                'title'        => 'Creator - create and manage an exam',
                'show-options' => array(
                        'del-exam'    => array(
                                'target'        => 'del-exam',
                                'show-on-flags' => array(
                                        "deletable",
                                )
                        ),
                        'reuse-exam'  => array(
                                'target'        => 'reuse-exam',
                                'show-on-flags' => array(
                                        'reusable'
                                )
                        ),
                        'test-exam'   => array(
                                'target'        => 'exam/{exam-id}',
                                'show-on-flags' => array(
                                        "contributable"
                                )
                        ),
                        'view-exam'   => array(
                                'target'        => 'exam/{exam-id}/question/all',
                                'show-on-flags' => array(
                                        "published"
                                )
                        ),
                        'manage-exam' => array(
                                'target'        => 'exam/update/{exam-id}/creator',
                                'show-on-flags' => array(
                                        "*"
                                )
                        ),
                )
        ),
        Roles::CONTRIBUTOR           => array(
                'title'        => 'Contributor - add questions to an exam',
                'show-options' => array(
                        'add-q'     => array(
                                'target'        => 'exam/update/{exam-id}/contributor/add-q',
                                'show-on-flags' => array(
                                        "contributable"
                                )
                        ),
                        'view-exam' => array(
                                'target'        => 'exam/update/{exam-id}/contributor',
                                'show-on-flags' => array(
                                        '*'
                                )
                        )
                )
        ),
        Roles::INVIGILATOR           => array(
                'title'        => 'Invigilator',
                'show-options' => array(
                        'change-time'    => array(
                                'target'        => 'change-time',
                                'show-on-flags' => array(
                                        "examinatable"
                                )
                        ),
                        'manage-student' => array(
                                'target'        => 'manage-students',
                                'show-on-flags' => array(
                                        "examinatable"
                                )
                        )
                )
        ),
        Roles::CORRECTOR             => array(
                'title'        => 'Corrector - correct the student\'s answers',
                'show-options' => array(
                        'download-result'   => array(
                                'target'        => 'exam/{exam-id}/correction/download-result',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'view-scoreboard'   => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'ans-correction'    => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "correctable"
                                )
                        ),
                        'exam-not-finished' => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                        "upcoming",
                                        "running",
                                )
                        ),
                )
        ),
        Roles::DECODER               => array(
                'title'        => 'Decoder - view and decode results',
                'show-options' => array(
                        'download-result' => array(
                                'target'        => 'exam/{exam-id}/correction/download-results',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        ),
                        'view-scoreboard' => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "correctable",
                                        "decodable",
                                        "decoded"
                                )
                        ),
                        'decode-exam'     => array(
                                'target'        => 'exam/{exam-id}/correction',
                                'show-on-flags' => array(
                                        "decodable"
                                )
                        ),
                        'decode-closed'   => array(
                                'target'        => '#',
                                'show-on-flags' => array(
                                )
                        ),
                )
        ),
        Roles::STUDENT . '-upcoming' => array(
                'title'        => 'Your upcoming/ongoing exams',
                'show-options' => array(
                        'st-exam-page' => array(
                                'target'        => 'exam/{exam-id}',
                                'show-on-flags' => array(
                                        "*"
                                )
                        )
                )
        ),
        Roles::STUDENT . '-finished' => array(
                'title'        => 'Your finished exams',
                'show-options' => array(
                        'download-result' => array(
                                'target'        => 'result/{exam-id}/download',
                                'show-on-flags' => array(
                                        "decoded"
                                )
                        )
                )
        ),
);

$opButtonsHtml = array(
        'manage-exam'       => '<span class="label label-green"><i class="fa fa-gear"></i> Manage</span>',
        'test-exam'         => '<span class="label label-blue"><i class="fa fa-thumbs-o-up"></i> Test exam</span>',
        'del-exam'          => '<span class="label label-red"><i class="fa fa-trash"></i> Delete</span>',
        'reuse-exam'        => '<span class="label label-primary" style="background-color: #4285F4"><i class="fa fa-refresh"></i> Reuse</span>',
        'view-exam'         => '<span class="label label-green"><i class="fa fa-question-circle"></i> View exam</span>',
        'add-q'             => '<span class="label label-blue"><i class="fa fa-pencil-square-o"></i> Add questions</span>',
        'ans-correction'    => '<span class="label label-green"><i class="fa fa-check-square-o"></i> Answer correction</span>',
        'exam-not-finished' => '<span class="label label-primary"><i class="fa fa-times"></i> Exam not finished yet</span>',
        'view-results'      => '<span class="label label-warning"><i class="fa fa-line-chart"></i> View results</span>',
        'view-scoreboard'   => '<span class="label label-warning"><i class="fa fa-trophy"></i> View Score board</span>',
        'download-result'   => '<span class="label label-primary" style="background-color: #4285F4"><i class="fa fa-download"></i> Download results</span>',
        'decode-exam'       => '<span class="label label-green"><i class="fa fa-code"></i> Decode this exam</span>',
        'decode-closed'     => '<span class="label label-primary"><i class="fa fa-times"></i> Not open for decoding yet</span>',
        'manage-student'    => '<span class="label label-green"><i class="fa fa-user"></i> Manage students</span>',
        'change-time'       => '<span class="label label-blue"><i class="fa fa-clock-o"></i> Change schedule</span>',
        'st-exam-page'      => '<span class="label label-green"><i class="fa fa-gear"></i> Go to exam page</span>',
        'st-view-exam'      => '<span class="label label-green"><i class="fa fa-gear"></i> View exam</span>'
);

$examsPerPage = 5;

?>

<div id="container" class="left_menu_space container" style="width:100%">

    <div class="hero-unit" style="margin:15px">
        <h1>Hej <?= explode(" ", $this->helper->getCatalogAttribute($this->user->getPrincipalName(), 'name'))[0] ?>!</h1>
        <div style="padding:10px 0px">
            The content of this page depends on the different roles you have. Information about the different roles (creator, contributor, corrector, invigilator, student) can be found <a href="<?= $this->url->get('/help/manual/teacher') ?>">teacher manual</a>.  
        </div>
    </div>
    <section class="ac-container">
        <?php $sectId = 1; ?>
        <?php foreach ($roleBasedExamList as $role => $exams) : ?>
                <div>
                    <?php if (in_array($role, $expandExamTabs)): ?>
                            <input id="ac-<?= $sectId ?>" name="accordion-1" type="radio" checked="" />
                    <?php else: ?>
                            <input id="ac-<?= $sectId ?>" name="accordion-1" type="radio"/>
                    <?php endif; ?>

                    <label for="ac-<?= $sectId ?>" class="exam-list-boxes">
                        <i class="fa fa-chevron-right chevron" style="font-size: 16px; color: #990000"></i>
                        <?= $sections[$role]['title'] ?>
                    </label>
                    <?php $title = str_replace(" ", "_", $sections[$role]['title']); ?>
                    <article class="ac-large exam-listing-wrapper" data-id="<?= $title ?>" exam-role="<?= (stristr($role, Roles::STUDENT) ? Roles::STUDENT : $role) ?>" section-role="<?= $role ?>">
                        <?php if ($role == Roles::CREATOR): ?>
                                <a href="<?= $this->url->get('exam/create') ?>"> 
                                    <span style="float: right; font-size: 12px; padding: 5px"> 
                                        <span class="label label-blue" style="margin-right: 26px; background-color:#3D7489">
                                            <i class="fa fa-plus-square"></i> Create a new exam
                                        </span> 
                                    </span> 
                                </a>
                        <?php endif; ?>

                        <?php $totalExams = count($exams); ?>
                        <?php if ($totalExams): ?>
                                <?php if ($totalExams > $examsPerPage): ?>
                                        <div style="float:right; padding:5px;">
                                            <input type="text" class="exam-search-box" placeholder="Quick search for exams as exam <?= (stristr($role, Roles::STUDENT) ? Roles::STUDENT : $role) ?>">
                                            <span class="label label-orange search-exam"><i class="fa fa-search" style="color:#FFF"></i></span> 
                                        </div>
                                <?php endif; ?>
                                <div>
                                    <div class="exam-listing-area" style="min-height:400px">
                                        <ul class="list-group exam-list">
                                            <li class="list-group-item" style="background-color: rgb(245, 245, 245); padding: 5px; font-size: 11px;">
                                                <span style="font-size:9px">Sort by: </span>
                                                <select class="exam-sort-by" style="font-size: 9px; height: 20px; width: 95px;">
                                                    <option value="created">Date created</option>
                                                    <option value="name">Exam title</option>
                                                    <option value="code">Exam code</option>
                                                    <option value="starttime">Exam starts</option>                                                        
                                                </select>
                                                <i class="fa fa-arrow-circle-down fa-lg exam-sort-order" order="desc" style="color: rgb(193, 0, 43);"></i>
                                            </li>
                                            <?php $count = 1; ?>
                                            <?php foreach ($exams as $exam): ?>
                                                    <li class="list-group-item" data-id="<?= $exam->id ?>" style=" <?= $exam->published && $role == Roles::CREATOR ? 'background-color:#ffffed' : '' ?>">
                                                        <div style="float:left;margin-top: 0px"> 
                                                            <span class="exam-status">
                                                                <?php
                                                                if ($exam->state & State::PUBLISHED) {
                                                                        printf("<i class=\"fa fa-check-square-o published-exam\" style=\"color:green;\"></i>\n");
                                                                        printf("<i class=\"fa fa-question draft-exam\" style=\"color:lightgray;display:none\"></i>\n");
                                                                        printf("<i class=\"fa fa-pencil-square-o upcoming-exam\" style=\"color:red;display:none\"></i>\n");
                                                                } elseif ($exam->state & State::DRAFT) {
                                                                        printf("<i class=\"fa fa-check-square-o published-exam\" style=\"color:green;display:none\"></i>\n");
                                                                        printf("<i class=\"fa fa-question-circle draft-exam\" style=\"color:lightgray;\"></i>\n");
                                                                        printf("<i class=\"fa fa-pencil-square-o upcoming-exam\" style=\"color:red;display:none\"></i>\n");
                                                                } else {
                                                                        printf("<i class=\"fa fa-check-square-o published-exam\" style=\"color:green;display:none\"></i>\n");
                                                                        printf("<i class=\"fa fa-question draft-exam\" style=\"color:lightgray;display:none\"></i>\n");
                                                                        printf("<i class=\"fa fa-pencil-square-o upcoming-exam\" style=\"color:red;\"></i>\n");
                                                                }

                                                                ?>
                                                            </span>
                                                            <?php
                                                            $progress = new Progress($exam->id, $role, $exam->getState());
                                                            $progress->render();

                                                            ?>
                                                            <a href="#"
                                                               class="exam-state-show"
                                                               title="Click to display exam details"
                                                               style="cursor: pointer">
                                                                <span class="exam-date label label-blue-outline" style="margin-right: 10px; margin-left: 5px; min-width: 200px;">
                                                                    <i class="fa fa-clock-o"></i> 
                                                                    <?php
                                                                    if (isset($exam->starttime)) {
                                                                            echo strftime("%x", strtotime($exam->starttime));
                                                                    } else {
                                                                            echo "---";
                                                                    }

                                                                    ?>
                                                                </span>
                                                                <span class="exam-name">
                                                                    <?= trim($exam->name) != "" ? $exam->name : 'Untitled exam' ?>
                                                                    <?= !empty($exam->code) ? " (" . $exam->code . ") " : "" ?>
                                                                </span>
                                                            </a>
                                                        </div>
                                                        <div style="float:right">
                                                            <div class="exam-show-options">
                                                                <?php foreach ($sections[$role]['show-options'] as $op => $opData): ?>

                                                                        <?php $isUrl = preg_match('/.*\/.*/', $opData['target']); ?>
                                                                        <?php if ($opData['show-on-flags'][0] == '*' || count(array_diff($opData['show-on-flags'], $exam->flags)) != count($opData['show-on-flags'])) : ?>
                                                                                <?php $href = ($isUrl ? str_replace("{exam-id}", $exam->id, $opData['target']) : '#'); ?>
                                                                                <a data-id="<?= $exam->id ?>" 
                                                                                   href="<?= $this->url->get($href) ?>" 
                                                                                   class="<?= ($isUrl ? '' : $opData['target'] . ' prevent') ?>"
                                                                                   <?= (stristr($role, Roles::STUDENT)) ? 'target="_blank"' : '' ?>>
                                                                                       <?= $opButtonsHtml[$op] ?>
                                                                                </a>
                                                                        <?php endif; ?>

                                                                <?php endforeach; ?>
                                                            </div>
                                                            <div style="padding-top: 5px; float:right; clear:both; display:none">
                                                                <span class="exam-date" style="padding-right: 5px; font-size: 9px;">
                                                                    <i class="fa fa-calendar"></i>
                                                                    <span><?= date("Y-m-d", strtotime($exam->starttime)) ?></span>
                                                                </span> 
                                                                <span style="font-size: 9px;"> <i class="fa fa-clock-o"></i>
                                                                    <span class="exam-starts"><?= date("H:i", strtotime($exam->starttime)) ?></span>
                                                                    &mdash;
                                                                    <span class="exam-ends"><?= date("H:i", strtotime($exam->endtime)) ?></span>
                                                                </span> 
                                                            </div>
                                                        </div>
                                                        <div style="clear:both" class="exam-state-view">
                                                            <!-- exam details (phase, datetime and state) -->
                                                            <div style="display: none"></div>
                                                        </div>
                                                    </li>
                                                    <?php if ($count == $examsPerPage) break; ?>
                                                    <?php $count++; ?>
                                            <?php endforeach; ?>
                                        </ul>
                                        <?php
                                        $totalPages = ceil($totalExams / $examsPerPage);
                                        if ($totalPages > 1):

                                                ?>
                                                <div style=" float: right; left: -50%; margin-bottom: 2em; position: relative; text-align: left;">
                                                    <ul class="pagination" style="left: 50%; list-style: none outside none; margin: 0; padding: 0; position: relative;">
                                                        <!--<li class="disabled"><a href="#">«</a></li>-->
                                                        <?php
                                                        for ($i = 1; $i <= $totalPages; $i++):

                                                                ?>
                                                                <li class="<?= ($i == 1) ? 'active' : '' ?>" offset="<?= (($i - 1) * $examsPerPage) ?>">
                                                                    <a href="#" style="padding:0px 9px"><?= $i ?><span class="sr-only">(current)</span></a> 
                                                                </li>
                                                        <?php endfor; ?>
                                                    </ul>
                                                </div>
                                        <?php endif; ?>
                                    </div>
                                </div>       
                        <?php else: ?>
                                <div class="exam-listing-default-msg"> 
                                    <?php if (stristr($role, Roles::STUDENT)): ?>
                                            <i class="fa fa-info-circle"></i> Currently you don't have any <?= str_replace("student-", "", $role) ?> exams.
                                    <?php else: ?>
                                            <i class="fa fa-info-circle"></i> Currently you don't have any exams as <?= $role ?>.
                                    <?php endif; ?>
                                </div>
                        <?php endif; ?>
                    </article>
                    <?php $examData = array(); ?>
                    <?php foreach ($exams as $exam): ?>
                            <?php $examData[$exam->id] = $exam->toArray(); ?>
                    <?php endforeach; ?>
                </div>
                <?php $sectId++; ?>
        <?php endforeach; ?>
        <input id="ac-hidden" type="radio" name="accordion-1">
        <label for="ac-hidden" id="ac-hidden-label" style="display:none">
            <i class="fa fa-chevron-right chevron" style="font-size: 16px; color: #990000"></i>
        </label>
        <article class="ac-large"  style="display:none">
        </article>
    </section>

    <!--
        Dialog for managing students on exam.
    -->
    <div id="mng-students" title="Manage students for exam" style="display:none"></div>

    <!--    
        Dialog for reusing exam (copy properties and questions).
    -->
    <div id="reuse-exam-dialog" title="Reuse exam" style="display:none">
        <div style="margin-top:15px; margin-bottom:10px">
            Along with <strong>Exam title, instructions and exam settings</strong>, please select if any of the following exam parts you would like to reuse:
        </div>
        <div style="margin-left:25px">
            <input type="checkbox" value="topics" class="exam-reuse-opt">
            Question sections<br>
            <input type="checkbox" value="questions" class="exam-reuse-opt">
            Questions and question correctors<br>
            <input type="checkbox" value="roles"  class="exam-reuse-opt">
            Exam roles<br>
        </div>         
    </div>

    <!--    
        Dialog for changing exam schedule.
    -->
    <div id="exam-datetime-changer" style="display: none" title="Change exam schedule">
        <div class="exam-datetime-select" style="padding: 10px">
            <label for="starttime">Start time:</label>
            <input type="text" value="" id="exam-starttime" name="starttime" placeholder="yyyy-mm-dd hh:mm:ss">
            <label for="endtime">End time:</label>
            <input type="text" value="" id="exam-endtime"   name="endtime" placeholder="yyyy-mm-dd hh:mm:ss">
        </div>
    </div>

    <?php foreach ($opButtonsHtml as $btnKey => $btnHtml): ?>
            <div id="<?= $btnKey ?>" style="display:none"><?= $btnHtml ?></div>
    <?php endforeach; ?>

    <!-- container -->
</div>

<?= Phalcon\Tag::javascriptInclude('js/views/exam/index.js') ?>

<script>
        var examSections = <?= json_encode($sections); ?>;
        var examPerPage = <?= $examsPerPage ?>;
</script>