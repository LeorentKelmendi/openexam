<?php

namespace OpenExam\Library\Core\Exam;

use OpenExam\Models\Answer;
use OpenExam\Models\Exam;
use OpenExam\Models\Question;
use OpenExam\Models\Result;
use OpenExam\Models\Student;
use OpenExam\Models\Topic;
use OpenExam\Tests\Phalcon\TestCase;

/**
 * Generated by PHPUnit_SkeletonGenerator on 2014-09-30 at 23:00:36.
 * @author Anders LÃ¶vgren (Computing Department at BMC, Uppsala University)
 */
class StateTest extends TestCase
{

        /**
         * @var State
         */
        protected $state;
        /**
         * @var Exam 
         */
        protected $exam;
        /**
         * @var array 
         */
        protected static $data;

        /**
         * Sets up the fixture, for example, opens a network connection.
         * This method is called before a test is executed.
         */
        protected function setUp()
        {
                parent::setUp();

                self::$data = array(
                        'exam'     => array(
                                'name'    => 'Exam 1',
                                'creator' => $this->caller,
                                'orgunit' => 'orgunit1',
                                'grades'  => json_encode(array('data' => array('U' => 0, 'G' => 20, 'VG' => 30)))
                        ),
                        'student'  => array(
                                'exam_id' => 0,
                                'user'    => $this->caller,
                                'code'    => '1234ABCD'
                        ),
                        'topic'    => array(
                                'exam_id'   => 0,
                                'name'      => 'Topic 1',
                                'randomize' => 0
                        ),
                        'question' => array(
                                'exam_id'  => 0,
                                'topic_id' => 0,
                                'score'    => 1.0,
                                'name'     => 'Question 1',
                                'quest'    => 'Question text',
                                'user'     => $this->caller,
                        ),
                        'answer'   => array(
                                'question_id' => 0,
                                'student_id'  => 0,
                                'answered'    => true
                        ),
                        'result'   => array(
                                'answer_id'  => 0,
                                'score'      => 1.5,
                                'correction' => 'completed'
                        )
                );

                $this->addExam();
                $this->addStudent();
                $this->addTopic();
                $this->addQuestion();

                $this->state = new State($this->exam);
        }

        /**
         * Tears down the fixture, for example, closes a network connection.
         * This method is called after a test is executed.
         */
        protected function tearDown()
        {
                if (isset($this->exam)) {
                        $this->exam->delete();
                }
        }

        private function addExam()
        {
                $this->exam = new Exam();
                $this->exam->create(self::$data['exam']);
        }

        private function addStudent()
        {
                self::$data['student']['exam_id'] = $this->exam->id;
                $this->student = new Student();
                $this->student->create(self::$data['student']);
        }

        private function addTopic()
        {
                self::$data['topic']['exam_id'] = $this->exam->id;
                $this->topic = new Topic();
                $this->topic->create(self::$data['topic']);
        }

        private function addQuestion()
        {
                self::$data['question']['exam_id'] = $this->exam->id;
                self::$data['question']['topic_id'] = $this->topic->id;
                $this->question = new Question();
                $this->question->create(self::$data['question']);
        }

        private function addAnswer()
        {
                self::$data['answer']['student_id'] = $this->student->id;
                self::$data['answer']['question_id'] = $this->question->id;
                $this->answer = new Answer();
                $this->answer->create(self::$data['answer']);

                self::$data['result']['answer_id'] = $this->answer->id;
                self::$data['result']['corrector_id'] = $this->question->correctors[0]->id;
        }

        private function addResult()
        {
                $this->result = new Result();
                $this->result->create(self::$data['result']);
        }

        /**
         * @covers OpenExam\Library\Core\Exam\State::getState
         * @group core
         */
        public function testGetState()
        {
                self::assertTrue($this->state->getState() != 0);

                // 
                // Before examination started (unpublished):
                // 
                $this->exam->published = false;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);

                $this->exam->update();
                $this->state->refresh();

                print_r($this->state->getFlags());

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) != 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) != 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) != 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) != 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) == 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) != 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) == 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) != 0);

                // 
                // Before examination started (published):
                // 
                $this->exam->published = true;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) != 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) != 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) != 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) == 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) != 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) == 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) != 0);

                // 
                // Ongoing examination (unseen):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) != 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) != 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) != 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) == 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) != 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) != 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) == 0);

                // 
                // Ongoing examination (seen):
                // 
                $this->addAnswer();

                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) != 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) == 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) == 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) != 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) == 0);

                // 
                // Finished examination (not yet corrected):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) != 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) == 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) != 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) == 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) == 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) == 0);

                // 
                // Finished examination (corrected):
                // 
                $this->addResult();
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) != 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) != 0);
                self::assertTrue(($this->state->getState() & State::DECODED) == 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) == 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) != 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) == 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) == 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) == 0);

                // 
                // Finished examination (decoded):
                // 
                $this->exam->decoded = true;
                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::CONTRIBUTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::CORRECTABLE) == 0);
                self::assertTrue(($this->state->getState() & State::DECODABLE) != 0);
                self::assertTrue(($this->state->getState() & State::DECODED) != 0);
                self::assertTrue(($this->state->getState() & State::DELETABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EDITABLE) == 0);
                self::assertTrue(($this->state->getState() & State::EXAMINATABLE) == 0);
                self::assertTrue(($this->state->getState() & State::FINISHED) != 0);
                self::assertTrue(($this->state->getState() & State::REUSABLE) == 0);
                self::assertTrue(($this->state->getState() & State::RUNNING) == 0);
                self::assertTrue(($this->state->getState() & State::UPCOMING) == 0);

                // 
                // Test custom state:
                // 
                self::assertTrue(($this->state->getState() & State::TESTCASE) == 0);
                self::assertTrue(($this->state->getState() & State::LOCKDOWN) == 0);
                self::assertTrue(($this->state->getState() & State::PUBLISHED) != 0);

                $this->exam->lockdown = array('enable' => true);
                $this->exam->testcase = true;
                $this->exam->published = true;

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue(($this->state->getState() & State::TESTCASE) != 0);
                self::assertTrue(($this->state->getState() & State::LOCKDOWN) != 0);
                self::assertTrue(($this->state->getState() & State::PUBLISHED) != 0);
        }

        /**
         * @covers OpenExam\Library\Core\Exam\State::has
         * @group core
         */
        public function testHas()
        {
                self::assertTrue($this->state->getState() != 0);

                // 
                // Before examination started (unpublished):
                // 
                $this->exam->published = false;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertTrue($this->state->has(State::CONTRIBUTABLE));
                self::assertFalse($this->state->has(State::CORRECTABLE));
                self::assertFalse($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertTrue($this->state->has(State::DELETABLE));
                self::assertTrue($this->state->has(State::EDITABLE));
                self::assertTrue($this->state->has(State::EXAMINATABLE));
                self::assertFalse($this->state->has(State::FINISHED));
                self::assertTrue($this->state->has(State::REUSABLE));
                self::assertFalse($this->state->has(State::RUNNING));
                self::assertTrue($this->state->has(State::UPCOMING));

                // 
                // Before examination started (published):
                // 
                $this->exam->published = true;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertTrue($this->state->has(State::CONTRIBUTABLE));
                self::assertFalse($this->state->has(State::CORRECTABLE));
                self::assertFalse($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertTrue($this->state->has(State::EDITABLE));
                self::assertTrue($this->state->has(State::EXAMINATABLE));
                self::assertFalse($this->state->has(State::FINISHED));
                self::assertTrue($this->state->has(State::REUSABLE));
                self::assertFalse($this->state->has(State::RUNNING));
                self::assertTrue($this->state->has(State::UPCOMING));

                // 
                // Ongoing examination (unseen):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertTrue($this->state->has(State::CONTRIBUTABLE));
                self::assertFalse($this->state->has(State::CORRECTABLE));
                self::assertFalse($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertTrue($this->state->has(State::EDITABLE));
                self::assertTrue($this->state->has(State::EXAMINATABLE));
                self::assertFalse($this->state->has(State::FINISHED));
                self::assertTrue($this->state->has(State::REUSABLE));
                self::assertTrue($this->state->has(State::RUNNING));
                self::assertFalse($this->state->has(State::UPCOMING));

                // 
                // Ongoing examination (seen):
                // 
                $this->addAnswer();
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertFalse($this->state->has(State::CONTRIBUTABLE));
                self::assertFalse($this->state->has(State::CORRECTABLE));
                self::assertFalse($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertFalse($this->state->has(State::EDITABLE));
                self::assertTrue($this->state->has(State::EXAMINATABLE));
                self::assertFalse($this->state->has(State::FINISHED));
                self::assertFalse($this->state->has(State::REUSABLE));
                self::assertTrue($this->state->has(State::RUNNING));
                self::assertFalse($this->state->has(State::UPCOMING));
                
                // 
                // Finished examination (not yet corrected):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertFalse($this->state->has(State::CONTRIBUTABLE));
                self::assertTrue($this->state->has(State::CORRECTABLE));
                self::assertFalse($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertFalse($this->state->has(State::EDITABLE));
                self::assertFalse($this->state->has(State::EXAMINATABLE));
                self::assertTrue($this->state->has(State::FINISHED));
                self::assertFalse($this->state->has(State::REUSABLE));
                self::assertFalse($this->state->has(State::RUNNING));
                self::assertFalse($this->state->has(State::UPCOMING));

                // 
                // Finished examination (corrected):
                // 
                $this->addResult();

                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);
                
                $this->exam->update();
                $this->state->refresh();

                self::assertFalse($this->state->has(State::CONTRIBUTABLE));
                self::assertTrue($this->state->has(State::CORRECTABLE));
                self::assertTrue($this->state->has(State::DECODABLE));
                self::assertFalse($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertFalse($this->state->has(State::EDITABLE));
                self::assertFalse($this->state->has(State::EXAMINATABLE));
                self::assertTrue($this->state->has(State::FINISHED));
                self::assertFalse($this->state->has(State::REUSABLE));
                self::assertFalse($this->state->has(State::RUNNING));
                self::assertFalse($this->state->has(State::UPCOMING));

                // 
                // Finished examination (decoded):
                // 
                $this->exam->decoded = true;
                $this->exam->update();
                $this->state->refresh();

                self::assertFalse($this->state->has(State::CONTRIBUTABLE));
                self::assertFalse($this->state->has(State::CORRECTABLE));
                self::assertTrue($this->state->has(State::DECODABLE));
                self::assertTrue($this->state->has(State::DECODED));
                self::assertFalse($this->state->has(State::DELETABLE));
                self::assertFalse($this->state->has(State::EDITABLE));
                self::assertFalse($this->state->has(State::EXAMINATABLE));
                self::assertTrue($this->state->has(State::FINISHED));
                self::assertFalse($this->state->has(State::REUSABLE));
                self::assertFalse($this->state->has(State::RUNNING));
                self::assertFalse($this->state->has(State::UPCOMING));

                // 
                // Test custom state:
                // 
                self::assertFalse($this->state->has(State::TESTCASE));
                self::assertFalse($this->state->has(State::LOCKDOWN));
                self::assertTrue($this->state->has(State::PUBLISHED));

                $this->exam->lockdown = array('enable' => true);
                $this->exam->testcase = true;
                $this->exam->published = true;

                $this->exam->update();
                $this->state->refresh();

                self::assertTrue($this->state->has(State::TESTCASE));
                self::assertTrue($this->state->has(State::LOCKDOWN));
                self::assertTrue($this->state->has(State::PUBLISHED));
        }

        /**
         * @covers OpenExam\Library\Core\Exam\State::getFlags()
         * @group core
         */
        public function testGetFlags()
        {
                self::assertTrue(is_array($this->state->getFlags()));

                // 
                // Before examination started (unpublished):
                // 
                $this->exam->published = false;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Before examination started (unpublished):\n");
                print_r($flags);

                self::assertTrue(in_array('contributable', $flags));
                self::assertFalse(in_array('correctable', $flags));
                self::assertFalse(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertTrue(in_array('deletable', $flags));
                self::assertTrue(in_array('editable', $flags));
                self::assertTrue(in_array('examinatable', $flags));
                self::assertFalse(in_array('finished', $flags));
                self::assertTrue(in_array('reusable', $flags));
                self::assertFalse(in_array('running', $flags));
                self::assertTrue(in_array('upcoming', $flags));

                // 
                // Before examination started (published):
                // 
                $this->exam->published = true;
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() + 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 120);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Before examination started (published):\n");
                print_r($flags);

                self::assertTrue(in_array('contributable', $flags));
                self::assertFalse(in_array('correctable', $flags));
                self::assertFalse(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertTrue(in_array('editable', $flags));
                self::assertTrue(in_array('examinatable', $flags));
                self::assertFalse(in_array('finished', $flags));
                self::assertTrue(in_array('reusable', $flags));
                self::assertFalse(in_array('running', $flags));
                self::assertTrue(in_array('upcoming', $flags));

                // 
                // Ongoing examination (unseen):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Ongoing examination (unseen):\n");
                print_r($flags);

                self::assertTrue(in_array('contributable', $flags));
                self::assertFalse(in_array('correctable', $flags));
                self::assertFalse(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertTrue(in_array('editable', $flags));
                self::assertTrue(in_array('examinatable', $flags));
                self::assertFalse(in_array('finished', $flags));
                self::assertTrue(in_array('reusable', $flags));
                self::assertTrue(in_array('running', $flags));
                self::assertFalse(in_array('upcoming', $flags));

                // 
                // Ongoing examination (seen):
                // 
                $this->addAnswer();
                
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 60);
                $this->exam->endtime = date('Y-m-d H:i:s', time() + 60);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Ongoing examination (seen):\n");
                print_r($flags);

                self::assertFalse(in_array('contributable', $flags));
                self::assertFalse(in_array('correctable', $flags));
                self::assertFalse(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertFalse(in_array('editable', $flags));
                self::assertTrue(in_array('examinatable', $flags));
                self::assertFalse(in_array('finished', $flags));
                self::assertFalse(in_array('reusable', $flags));
                self::assertTrue(in_array('running', $flags));
                self::assertFalse(in_array('upcoming', $flags));

                // 
                // Finished examination (not yet corrected):
                // 
                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Finished examination (not yet corrected):\n");
                print_r($flags);

                self::assertFalse(in_array('contributable', $flags));
                self::assertTrue(in_array('correctable', $flags));
                self::assertFalse(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertFalse(in_array('editable', $flags));
                self::assertFalse(in_array('examinatable', $flags));
                self::assertTrue(in_array('finished', $flags));
                self::assertFalse(in_array('reusable', $flags));
                self::assertFalse(in_array('running', $flags));
                self::assertFalse(in_array('upcoming', $flags));

                // 
                // Finished examination (corrected):
                // 
                $this->addResult();

                $this->exam->starttime = date('Y-m-d H:i:s', time() - 120);
                $this->exam->endtime = date('Y-m-d H:i:s', time() - 60);
                
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Finished examination (corrected):\n");
                print_r($flags);

                self::assertFalse(in_array('contributable', $flags));
                self::assertTrue(in_array('correctable', $flags));
                self::assertTrue(in_array('decodable', $flags));
                self::assertFalse(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertFalse(in_array('editable', $flags));
                self::assertFalse(in_array('examinatable', $flags));
                self::assertTrue(in_array('finished', $flags));
                self::assertFalse(in_array('reusable', $flags));
                self::assertFalse(in_array('running', $flags));
                self::assertFalse(in_array('upcoming', $flags));

                // 
                // Finished examination (decoded):
                // 
                $this->exam->decoded = true;
                $this->exam->update();
                $this->state->refresh();

                $flags = $this->state->getFlags();
                printf("Finished examination (decoded):\n");
                print_r($flags);

                self::assertFalse(in_array('contributable', $flags));
                self::assertFalse(in_array('correctable', $flags));
                self::assertTrue(in_array('decodable', $flags));
                self::assertTrue(in_array('decoded', $flags));
                self::assertFalse(in_array('deletable', $flags));
                self::assertFalse(in_array('editable', $flags));
                self::assertFalse(in_array('examinatable', $flags));
                self::assertTrue(in_array('finished', $flags));
                self::assertFalse(in_array('reusable', $flags));
                self::assertFalse(in_array('running', $flags));
                self::assertFalse(in_array('upcoming', $flags));

                // 
                // Test custom state:
                // 
                self::assertFalse(in_array('testcase', $flags));
                self::assertFalse(in_array('lockdown', $flags));
                self::assertTrue(in_array('published', $flags));

                $this->exam->lockdown = array('enable' => true);
                $this->exam->testcase = true;
                $this->exam->published = true;

                $this->exam->update();
                $this->state->refresh();
                $flags = $this->state->getFlags();
                printf("Custom state (e.g. published):\n");
                print_r($flags);

                self::assertTrue(in_array('testcase', $flags));
                self::assertTrue(in_array('lockdown', $flags));
                self::assertTrue(in_array('published', $flags));
        }

}
