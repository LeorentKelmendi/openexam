#!/bin/bash
#
# Start/stop script for OpenExam. 
# 
# This script starts performance monitors and could be run at boot time. By default, 
# all enabled performance collectors are started using settings from the system
# configuration.
#
# Either tweak the settings in config.def or use a custom function for starting the
# collection, see run_perf_monitors() below.
#
# The collectors are prepared to be run with dropped privileges. Only some collectors
# requires root-permissions (e.g. apache).
# 
# Author: Anders LÃ¶vgren
# Date:   2016-06-12

# This script directory:
cwd="$(dirname $(realpath $0))"

# The phalcon directory:
root="$(realpath $cwd/../../phalcon-mvc)"

# Script to run:
script="$root/script/openexam.php"

# Standard user for running counters:
user="daemon"

# The mapping between collector and process user:
declare -A users=([system]=$user [server]=$user [apache]=root [mysql]=$user [net]=$user [fs]=$user [part]=$user [disk]=$user)

# Extra options:
#options="--verbose --force"

if ! [ -e $script ]; then
  echo "$0: missing script $script"
  exit 1
fi
if ! [ -d $root ]; then
  echo "$0: missing application directory $root"
  exit 1
fi

function run_perf_monitors()
{
    /usr/bin/php $script --performance --collect --server --uid=$user --rate=10
    /usr/bin/php $script --performance --collect --apache --uid=root  --rate=15  --user=apache
    /usr/bin/php $script --performance --collect --mysql  --uid=$user --rate=10 
    /usr/bin/php $script --performance --collect --net    --uid=$user --rate=5   --name=eth0:br0
    /usr/bin/php $script --performance --collect --fs     --uid=$user --rate=60  --path=/var/data:/home --type=ext4:btrfs:xfs
    /usr/bin/php $script --performance --collect --disk   --uid=$user --rate=300 --disk=sda
    /usr/bin/php $script --performance --collect --part   --uid=$user --rate=300 --part=/dev/sda1:/dev/md0
}

function start_perf_monitor()
{
    echo -n "Starting OpenExam performance collectors:"
    counters=$(/usr/bin/php $script --performance --list)
    for c in $counters; do 
        echo -n " $c"
        /usr/bin/php $script --performance --collect --$c --uid=${users[$c]} $options &
    done
    echo
}

function stop_perf_monitor()
{
    echo "Stopping OpenExam performance collectors"
    counters=$(/usr/bin/php $script --performance --list)
    for c in $counters; do 
        pkill -xf "/usr/bin/php $script --performance --collect --$c.*"
    done
}

case "$1" in
    start)
        start_perf_monitor
        ;;
    stop)
        stop_perf_monitor
        ;;
    restart)
        stop_perf_monitor
        start_perf_monitor
        ;;
    *)
        echo "usage: $0 start|stop"
esac
